# 概要
[homebridge-thermostat](https://www.npmjs.com/package/homebridge-thermostat)が要求するapiに従ってIRKitを使ってエアコンを制御するサーバです。Laravelで作成しています。

# 使い方

* 適当な場所にこのリポジトリを展開します

* ```composer install```

* ```.env```を用意します。```php artisan key:generate```とDB接続情報の設定は最低限必要です。
  特定のDBには依存しない程度の簡単なプログラムですが、動作確認はmysqlで行っています。
  
* ```php artisan migrate:install```と```php artisan migrate```

* config/irkit.phpとconfig/thermostat.phpを用意します(後述)

* 適当なサーバーでlarabelの実行環境を用意します。

# 設定ファイル

## config/irkit.php

crhg/laravel-irkitの設定ファイルです。

エアコンオフおよび冷房x℃, 暖房x℃に対応する赤外線リモコンのコマンドをひたすら設定します。

```php
<?php

return [
    "host" => [
        "host1" => [
            "uri" => "http://10.0.1.2",
            "http_option" => [
                "version" => 1.0,
                "headers" => [
                    "X-Requested-With" => "curl"
                ],
                "timeout" => 5
            ],
            "retry" => 5
        ]
    ],
    "accessory" => [
        "thermostat1" => [
            "host" => "host1",
            "command" => [
                "c32" => [
                    'format' => 'us',
                    'freq' => 36,
                    'data' => [
                        391, 480, 384, 491, 382, 491, 389, 483, 392, 483, 381, 25815, 3439, 1798, 393, 1355, 393, 483, 387, 486, 390, 483, 390, 1357, 382, 491, 382, 489, 390, 484, 389, 483, 386, 1364, 389, 480, 386, 1363, 383, 1367, 385, 486, 389, 1357, 391, 1356, 391, 1353, 394, 1357, 386, 1357, 391, 483, 392, 482, 382, 1364, 382, 491, 390, 483, 382, 490, 391, 482, 391, 486, 389, 484, 389, 484, 387, 487, 390, 482, 382, 491, 390, 1355, 390, 484, 392, 480, 391, 481, 385, 492, 390, 483, 388, 486, 387, 486, 387, 485, 382, 1365, 382, 1363, 392, 483, 391, 482, 388, 1358, 388, 486, 391, 479, 392, 1355, 385, 1366, 382, 490, 387, 486, 387, 488, 385, 486, 391, 1358, 388, 483, 388, 484, 389, 483, 392, 481, 385, 495, 378, 1368, 387, 485, 379, 1365, 389, 483, 390, 483, 392, 484, 380, 491, 391, 481, 390, 486, 389, 1355, 391, 483, 390, 485, 382, 1365, 390, 483, 381, 492, 387, 486, 389, 483, 390, 484, 389, 483, 391, 483, 383, 1363, 392, 482, 388, 484, 395, 478, 391, 483, 391, 483, 383, 495, 378, 492, 381, 493, 386, 486, 388, 485, 388, 486, 388, 485, 382, 489, 391, 483, 383, 490, 392, 484, 389, 482, 393, 478, 392, 486, 389, 483, 388, 486, 389, 484, 387, 487, 390, 484, 381, 491, 382, 490, 389, 483, 390, 483, 391, 483, 383, 492, 382, 494, 378, 492, 381, 492, 381, 492, 390, 485, 388, 484, 382, 490, 389, 483, 390, 483, 385, 493, 379, 493, 387, 486, 388, 484, 382, 494, 390, 484, 380, 490, 391, 481, 392, 482, 383, 489, 385, 488, 392, 484, 389, 486, 380, 492, 381, 495, 378, 493, 386, 486, 382, 491, 389, 484, 380, 493, 390, 483, 391, 482, 389, 484, 392, 480, 385, 493, 387, 486, 389, 483, 388, 485, 388, 486, 387, 485, 392, 484, 380, 491, 389, 484, 389, 1359, 389, 1354, 390, 1356, 394, 484, 380, 1366, 387, 1357, 384, 1364, 381, 35420, 3440, 1804, 380, 1364, 391, 483, 390, 483, 388, 488, 385, 1359, 382, 491, 382, 490, 383, 489, 393, 482, 382, 1362, 392, 486, 387, 1358, 381, 1365, 390, 483, 392, 1357, 389, 1357, 380, 1365, 390, 1353, 392, 1359, 387, 488, 386, 484, 392, 1354, 389, 485, 388, 484, 389, 485, 392, 483, 387, 489, 386, 484, 389, 484, 382, 491, 391, 483, 381, 491, 390, 484, 388, 482, 392, 485, 382, 491, 390, 483, 387, 486, 388, 486, 391, 482, 389, 1359, 387, 482, 392, 483, 383, 1366, 380, 1368, 378, 1367, 387, 483, 393, 480, 392, 481, 390, 483, 389, 485, 383, 493, 387, 486, 389, 484, 387, 1359, 390, 483, 382, 491, 383, 491, 388, 485, 388, 484, 391, 483, 381, 490, 385, 495, 387, 483, 380, 493, 380, 493, 381, 491, 388, 486, 392, 483, 387, 1356, 392, 484, 380, 1366, 387, 485, 390, 489, 386, 485, 387, 485, 387, 485, 390, 484, 389, 484, 386, 486, 383, 491, 388, 487, 386, 487, 381, 489, 389, 485, 388, 488, 389, 484, 380, 493, 387, 489, 384, 1361, 385, 1358, 383, 490, 392, 482, 382, 491, 390, 482, 389, 488, 386, 488, 386, 486, 389, 484, 380, 492, 390, 483, 383, 1362, 390, 1358, 390, 486, 378, 495, 380, 495, 387, 485, 378, 493, 387, 487, 380, 492, 389, 483, 384, 490, 391, 483, 390, 484, 382, 1365, 390, 484, 387, 485, 387, 1360, 386, 486, 390, 482, 384, 1362, 390, 484, 389, 485, 389, 483, 389, 491, 378, 494, 378, 1367, 380, 1365, 391, 482, 389, 483, 383, 491, 391, 484, 390, 483, 389, 482, 389, 483, 390, 1356, 384, 494, 380, 495, 378, 492, 390, 484, 389, 1357, 379, 493, 380, 1366, 390, 485, 389, 481, 390, 1356, 384, 1368, 385, 487, 386, 487, 387, 485, 382, 1364, 389, 483, 383,
                    ],
                ],

                "c31" => [
                    'format' => 'us',
                    'freq' => 35,
                    'data' => [
                        373, 491, 382, 491, 383, 490, 380, 494, 379, 497, 386, 25808, 3437, 1803, 380, 1365, 392, 486, 387, 486, 386, 487, 386, 1356, 391, 487, 386, 487, 389, 485, 385, 490, 383, 1363, 376, 495, 381, 1366, 380, 1366, 378, 497, 380, 1365, 380, 1366, 378, 1368, 380, 1367, 378, 1368, 381, 494, 376, 495, 379, 1370, 379, 491, 388, 486, 389, 486, 381, 491, 389, 483, 383, 491, 381, 491, 387, 487, 380, 493, 382, 491, 381, 1364, 381, 493, 380, 493, 381, 496, 376, 498, 379, 494, 379, 495, 379, 492, 378, 495, 379, 1369, 379, 1365, 379, 495, 382, 490, 384, 1363, 379, 495, 381, 491, 380, 1372, 374, 1370, 381, 491, 382, 491, 382, 492, 378, 495, 378, 1367, 391, 483, 383, 489, 383, 491, 382, 490, 383, 490, 380, 1372, 383, 491, 375, 1371, 378, 491, 382, 491, 382, 493, 379, 493, 378, 495, 381, 494, 380, 1367, 377, 493, 381, 492, 383, 1368, 376, 497, 376, 497, 377, 495, 382, 492, 381, 494, 378, 495, 377, 493, 379, 1367, 379, 495, 379, 496, 381, 490, 383, 490, 383, 490, 383, 491, 380, 492, 383, 491, 381, 496, 377, 496, 376, 499, 373, 497, 381, 491, 381, 493, 381, 491, 389, 485, 378, 495, 379, 493, 383, 490, 380, 493, 382, 494, 381, 490, 387, 489, 378, 495, 388, 486, 380, 495, 378, 495, 378, 491, 379, 495, 381, 493, 385, 487, 380, 493, 379, 497, 379, 492, 382, 491, 382, 490, 383, 491, 380, 493, 380, 497, 377, 497, 376, 496, 379, 495, 375, 499, 383, 488, 378, 497, 376, 495, 380, 493, 380, 495, 386, 485, 381, 494, 377, 495, 378, 497, 381, 491, 379, 492, 381, 493, 390, 483, 382, 490, 384, 490, 383, 495, 378, 495, 375, 496, 379, 497, 376, 494, 379, 496, 377, 495, 380, 493, 379, 495, 377, 494, 379, 496, 380, 494, 378, 493, 390, 483, 380, 1366, 383, 1364, 382, 1367, 380, 494, 378, 1367, 381, 1365, 379, 1369, 375, 35424, 3439, 1804, 379, 1368, 378, 494, 379, 495, 378, 494, 381, 1366, 382, 491, 380, 492, 381, 495, 381, 489, 382, 1365, 383, 489, 384, 1367, 381, 1368, 377, 495, 378, 1366, 381, 1364, 382, 1365, 378, 1368, 390, 1359, 377, 493, 381, 494, 403, 1346, 376, 497, 378, 495, 380, 494, 380, 494, 379, 491, 379, 495, 381, 492, 378, 496, 380, 492, 381, 495, 376, 495, 378, 494, 378, 495, 384, 491, 382, 491, 379, 492, 383, 493, 380, 490, 383, 1367, 377, 499, 383, 487, 381, 1366, 387, 1358, 381, 1366, 380, 495, 377, 494, 378, 497, 382, 1361, 382, 1367, 381, 1364, 379, 1370, 376, 1372, 385, 486, 381, 493, 380, 495, 378, 495, 378, 493, 378, 494, 383, 491, 382, 490, 381, 492, 383, 490, 383, 490, 383, 497, 376, 494, 380, 493, 377, 497, 387, 1359, 380, 493, 380, 1366, 380, 492, 381, 492, 381, 493, 381, 491, 383, 490, 379, 494, 383, 490, 384, 490, 383, 491, 379, 493, 382, 492, 378, 494, 383, 490, 379, 501, 377, 497, 376, 494, 385, 488, 380, 1367, 376, 1370, 377, 496, 376, 499, 375, 496, 378, 495, 379, 495, 379, 494, 387, 489, 376, 494, 378, 495, 377, 497, 381, 1365, 381, 1365, 379, 494, 381, 495, 378, 493, 381, 491, 382, 493, 380, 493, 378, 494, 380, 493, 379, 497, 376, 495, 379, 494, 379, 1368, 378, 497, 377, 497, 378, 1366, 383, 491, 377, 495, 382, 1365, 382, 491, 382, 491, 385, 488, 382, 491, 378, 496, 378, 1369, 386, 1365, 382, 485, 380, 498, 378, 495, 378, 495, 375, 499, 375, 497, 376, 497, 376, 1371, 380, 492, 380, 495, 376, 495, 377, 497, 376, 496, 377, 497, 378, 1369, 380, 494, 385, 487, 385, 488, 381, 1365, 378, 497, 379, 1368, 378, 1366, 387, 486, 387, 487, 386,
                    ],
                 ],
  
                /// ... 略 ...

                "h30" => [
                    'format' => 'us',
                    'freq' => 33,
                    'data' => [
                        65535, 522, 332, 1414, 348, 524, 352, 520, 333, 539, 399, 476, 377, 495, 337, 1409, 333, 541, 334, 1414, 332, 541, 354, 522, 329, 542, 424, 450, 334, 538, 354, 518, 364, 1384, 333, 538, 358, 518, 335, 95, 65535, 1313, 357, 520, 352, 521, 408, 466, 330, 542, 359, 513, 338, 538, 334, 540, 333, 1410, 336, 536, 359, 517, 332, 542, 352, 522, 353, 522, 389, 482, 335, 539, 330, 52, 65535, 488, 334, 539, 335, 539, 333, 77, 65535, 463, 335, 540, 354, 517, 383, 490, 336, 537, 333, 545, 329, 546, 376, 494, 424, 452, 350, 522, 330, 541, 392, 481, 331, 541, 334, 540, 333, 539, 338, 537, 392, 480, 375, 503, 392, 480, 348, 524, 332, 541, 335, 539, 334, 539, 333, 542, 348, 523, 335, 538, 355, 517, 337, 537, 334, 539, 372, 501, 349, 524, 335, 538, 357, 516, 362, 511, 338, 69, 65535, 466, 334, 539, 356, 518, 335, 543, 349, 523, 331, 542, 331, 544, 352, 519, 332, 541, 331, 541, 403, 471, 335, 537, 334, 539, 336, 537, 358, 515, 336, 542, 329, 544, 421, 454, 329, 541, 335, 539, 334, 538, 333, 540, 366, 507, 332, 541, 336, 540, 333, 538, 330, 544, 355, 517, 335, 1413, 372, 1377, 332, 538, 355, 1392, 334, 1411, 355, 1393, 391, 1353, 336, 35467, 3393, 1852, 331, 1414, 333, 543, 326, 544, 332, 543, 349, 1397, 328, 543, 334, 539, 330, 543, 353, 522, 332, 1420, 318, 548, 335, 1415, 332, 1413, 330, 543, 330, 1417, 323, 1422, 330, 1416, 356, 1395, 351, 1397, 328, 539, 331, 545, 333, 1414, 327, 545, 332, 543, 351, 522, 329, 545, 327, 547, 329, 541, 331, 541, 330, 544, 329, 544, 329, 548, 328, 545, 326, 547, 330, 544, 327, 546, 326, 546, 327, 548, 330, 543, 318, 555, 328, 1417, 321, 553, 328, 543, 328, 1418, 392, 484, 328, 545, 330, 1417, 327, 543, 334, 566, 303, 544, 329, 1446, 302, 1447, 298, 1420, 327, 1419, 329, 543, 329, 544, 329, 570, 294, 572, 312, 542, 334, 545, 325, 548, 326, 546, 318, 554, 330, 546, 324, 548, 327, 544, 331, 544, 326, 548, 318, 579, 301, 1421, 318, 553, 329, 1419, 423, 474, 295, 578, 295, 578, 376, 497, 303, 549, 329, 543, 321, 580, 299, 549, 327, 543, 361, 512, 328, 546, 327, 545, 321, 553, 320, 555, 417, 483, 300, 546, 321, 578, 304, 1440, 294, 1426, 329, 570, 335, 538, 307, 544, 320, 578, 305, 545, 316, 582, 338, 511, 357, 539, 302, 548, 321, 549, 321, 1428, 357, 1387, 329, 573, 300, 569, 309, 539, 320, 581, 304, 85, 65535, 483, 340, 532, 297, 577, 303, 570, 304, 563, 309, 570, 304, 546, 321, 1427, 327, 561, 315, 544, 328, 1443, 297, 578, 292, 578, 298, 1449, 299, 548, 332, 541, 331, 567, 298, 572, 300, 577, 295, 1429, 321, 1426, 326, 545, 319, 554, 319, 580, 329, 519, 323, 549, 425, 450, 319, 553, 359, 1408, 304, 573, 304, 79, 65535, 484, 312, 568, 297, 579, 336, 511, 318, 555, 318, 1454, 301, 545, 329, 77, 65535, 468, 366, 1382, 327, 571, 303, 65, 65535, 503, 381, 487, 303, 576, 308, 1431, 303, 584, 299,
                    ],
                ],


                /// ... 略 ...

                "off" => [
                    "format" => "us",
                    "freq" => 36,
                    "data" => [358,484,391,485,379,491,383,492,388,485,382,25808,3448,1790,394,1352,386,487,393,482,395,478,393,1353,393,480,393,481,390,483,390,481,386,1363,391,479,393,1354,394,1352,385,492,390,1351,393,1354,386,1367,385,1357,389,1356,391,484,389,487,389,1356,381,493,380,492,390,483,387,487,386,488,386,485,390,485,386,487,386,487,389,482,388,1361,390,483,387,486,390,480,392,481,390,483,391,485,381,491,388,484,390,483,383,490,392,483,390,1354,390,1357,391,483,391,481,389,1358,382,490,383,1363,389,484,390,482,390,487,387,1356,393,480,392,483,392,479,391,482,392,482,391,1354,394,479,385,1360,395,483,389,484,390,484,387,486,387,488,387,483,391,1356,390,483,388,485,388,1358,388,485,390,484,387,487,386,485,391,483,387,488,386,484,390,1359,387,484,392,484,385,486,390,482,390,484,389,484,391,484,388,484,389,486,385,487,386,486,390,482,390,485,387,487,389,481,393,480,392,483,390,481,392,483,388,486,388,483,389,484,391,484,390,481,390,483,383,491,391,483,388,484,389,484,388,486,390,481,390,483,390,483,390,483,392,483,395,478,392,479,392,481,385,489,393,479,392,485,388,485,382,491,389,484,388,485,388,488,379,494,385,488,385,486,387,488,388,483,388,486,386,487,388,485,387,485,388,487,386,488,385,487,388,484,389,486,387,483,390,483,393,480,393,484,389,480,384,491,389,483,390,484,391,483,388,483,393,480,392,482,383,1362,384,491,388,1359,381,1366,381,1364,388,1357,389,1358,391,35408,3437,1801,382,1364,388,486,387,485,389,485,388,1357,390,487,387,485,381,490,392,483,390,1354,390,483,391,1357,390,1354,392,481,392,1354,392,1354,390,1357,391,1354,394,1353,389,485,392,479,392,1354,386,488,384,489,385,491,381,493,380,493,388,485,387,485,388,489,387,483,381,493,380,492,390,483,390,484,389,483,390,484,381,492,381,492,381,493,387,486,387,488,385,486,387,1359,389,1359,388,1357,386,486,387,488,385,488,391,1353,391,485,387,1358,381,491,391,1354,391,482,392,484,380,490,384,489,390,483,390,483,390,483,390,484,391,484,390,484,389,484,387,484,390,483,383,491,391,483,388,1357,392,482,391,1355,388,486,388,483,390,485,389,484,387,486,387,486,389,483,388,486,381,493,380,493,389,484,387,488,387,485,389,483,381,492,387,487,380,493,387,1354,393,1354,385,492,381,489,393,483,391,478,394,479,395,479,393,480,389,486,384,487,386,491,390,1353,392,1354,392,483,383,492,390,486,387,484,380,493,379,493,387,488,385,489,386,485,390,484,391,483,389,1353,393,483,388,484,382,1363,393,482,382,490,391,1354,392,483,388,487,389,483,381,491,391,481,383,1365,390,1354,392,484,388,484,381,491,383,490,383,490,392,481,392,483,388,1356,390,484,391,482,390,485,387,484,389,483,393,482,389,1358,388,484,391,1355,392,1356,388,1357,388,1358,391,1355,392,481,383,491,389,485,388]
                    ],
            ],
        ],
    ]
];

```

## config/thermostat.php

thermostatの名前と対応するirkitのaccessory名、および冷房/暖房/オフのコマンドの対応関係の設定です。

冷房と暖房のコマンドは温度とコマンドのペアをリストにします。

```php
<?php

return [
    'thermostat1' => [
        'accessory' => 'thermostat1',
        'command' => [
            'cooling' => collect(range(18, 32))->map(function ($t) {
                return ['temperature' => $t, 'command' => 'c'.$t ];
            }),
            'heating' => collect(range(14, 30))->map(function ($t) {
                return ['temperature' => $t, 'command' => 'h'.$t ];
            }),
            'off' => 'off',
        ]
    ],
];
```

# homebridge-thermostatの設定

homebridgeのconfig.jsonに以下のような記述を追加します。

```json
{
  "accessories": [
    {
      "accessory": "Thermostat",
      "name": "エアコン",
      "apiroute": "http://localhost:8002/api/thermostat/thermostat1",
      "maxTemp": 30,
      "minTemp": 18
    }
  ]
}

```


